#!/bin/sh

#sed "s/^DAEMON=.*/DAEMON=nuri/" nuri-init

setup_configuration_file() {
	# setup configuration file
	echo -n "Setup configuration file..."
	cp etc/nuri-template.sfp etc/nuri.sfp
	sed -i 's/^\s*trusted.*/\ttrusted is \(__TRUSTED__\)/g' etc/nuri.sfp
	sed -i "s/__TRUSTED__/$TRUSTED/g" etc/nuri.sfp
	echo "OK"
}

install_required_softwares() {
	echo "Installing required softwares and libraries..."
	sudo apt-get -y update
	sudo apt-get -y install ruby1.9.1 ruby1.9.1-dev libz-dev \
		libaugeas-ruby1.9.1 make gcc libxml2-dev libxslt-dev
	sudo gem install webrick antlr3 json fog --no-ri --no-rdoc
	echo "...OK"
}

#DEST="$( cd "$( dirname "$0" )" && pwd )/nuri"
DEST="$( pwd )/nuri"
TRUSTED=""
if [ "$1" = "-silent" ]; then
	TRUSTED=$2
else
	read -p "What is the address of master node? " TRUSTED_INPUT
	TRUSTED_INPUT="$( echo $TRUSTED_INPUT | sed -e 's/^ *//g' -e 's/ *$//g' )"
	if [ "$TRUSTED_INPUT" != "" ]; then
		TRUSTED=$TRUSTED_INPUT
	fi
fi

TRUSTED="\"$TRUSTED\""

#install_required_softwares

if [ "$1" = "-environment" ]; then
	setup_configuration_file
	exit 1
fi

# download binaries from github repository
echo "Download binaries..."
/usr/bin/wget -O /tmp/nuri.tgz -o /dev/null https://github.com/herry13/nuri/tarball/master
echo "...OK"

if [ -f "/tmp/nuri.tgz" ]; then
	cd /tmp

	# extract
	/bin/tar xvf nuri.tgz
	# locate the directory, rename it, then change current directory
	DIR=`/bin/ls | grep 'herry13-nuri'`
	mv $DIR $DEST
	rm -f nuri.tgz

	cd $DEST

	setup_configuration_file

	# delete unused file
	#cd ..
	#rm -f nuri.tgz

	echo "finished"
fi
